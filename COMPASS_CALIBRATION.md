# 罗盘校准改进说明

## 概述
已对 `CompassAlignment.vue` 组件进行全面改进，增加了校准功能并提升了对主流Android和iOS系统的兼容性。

## 主要改进

### 1. 手动偏移校准 ✨
- **功能**：新增校准控制面板，允许用户手动调整罗盘偏移量
- **操作**：
  - 提供 ±1° 和 ±5° 的快速调整按钮
  - 实时显示当前偏移值
  - 偏移值保存到 localStorage，下次使用时自动应用
- **使用场景**：当罗盘指针与实际方向存在固定偏差时使用

### 2. 磁偏角补偿 🧭
- **功能**：可选的磁偏角补偿，将磁北转换为真北
- **实现**：
  - 基于用户地理位置自动计算磁偏角
  - 需要用户授权位置信息
  - 对中国地区提供简化的磁偏角估算
- **注意**：使用了简化的磁偏角模型，实际应用中建议使用 WMM (World Magnetic Model) API

### 3. 增强的iOS兼容性 🍎
- **改进点**：
  - 正确使用 `webkitCompassHeading` API
  - 监听屏幕方向变化事件
  - 支持 iOS 13+ 的权限请求机制
- **支持设备**：iPhone、iPad、iPod Touch

### 4. 增强的Android兼容性 🤖
- **设备检测**：新增对更多Android厂商的识别
  - 小米 (Xiaomi/Redmi)
  - 华为 (Huawei/Honor)
  - Oppo
  - Vivo
  - 三星 (Samsung)
  
- **特殊处理**：
  - 小米设备：自动反转 alpha 值（部分型号传感器定义与标准相反）
  - 华为设备：使用标准处理
  - Oppo/Vivo：预留特殊处理接口

### 5. 调试功能 🔍
- **显示信息**：
  - 原始传感器读数
  - 平滑后读数
  - 当前偏移量
  - 磁偏角值
  - 传感器类型
  - 设备信息
  - 屏幕方向
- **开启方式**：设置 `showDebug = true`

## 使用方法

### 基本使用
```vue
<CompassAlignment 
  :targetAzimuth="180" 
  :language="'zh'" 
/>
```

### 校准步骤

#### 步骤 1: 确定偏差
1. 点击"启动罗盘"按钮
2. 面向已知方向（如正北）
3. 观察罗盘显示的角度与实际方向的差异

#### 步骤 2: 调整偏移
1. 使用 ±1° 或 ±5° 按钮调整偏移量
2. 观察校准后的朝向是否与实际方向一致
3. 重复调整直到精确对准

#### 步骤 3: 保存设置
- 偏移值会自动保存到浏览器本地存储
- 下次使用时自动应用校准值

#### 重置校准
- 点击"重置"按钮恢复默认设置

### 磁偏角补偿

1. **启用**：勾选"磁偏角补偿"复选框
2. **授权**：允许浏览器访问位置信息
3. **自动计算**：系统根据GPS位置自动计算磁偏角
4. **应用**：罗盘自动从磁北转换为真北

## 技术细节

### 校准值存储
```javascript
// LocalStorage Keys
CALIBRATION_KEY = 'compass-manual-offset'  // 手动偏移量
DECLINATION_KEY = 'compass-use-declination' // 是否启用磁偏角补偿
```

### 传感器类型
- **iOS Compass**: 使用 `webkitCompassHeading`
- **Android Absolute**: 使用绝对方向传感器（`event.absolute === true`）
- **Android Relative**: 使用相对方向传感器

### 计算公式
```javascript
// 最终校准朝向
calibratedHeading = smoothedHeading + manualOffset - magneticDeclination

// 标准化到 0-360°
calibratedHeading = calibratedHeading % 360
if (calibratedHeading < 0) calibratedHeading += 360
```

## 已知限制

1. **磁偏角计算**：
   - 当前使用简化模型
   - 建议集成专业的 WMM API 获取精确值

2. **设备兼容性**：
   - 某些低端设备可能不支持方向传感器
   - 部分厂商的传感器实现可能存在差异

3. **浏览器要求**：
   - iOS 13+ 需要 HTTPS 环境
   - 某些浏览器可能需要用户手动授权传感器访问

## 测试建议

### iOS 设备测试
1. 在真机上测试（模拟器不支持传感器）
2. 确保使用 HTTPS 或 localhost
3. 测试屏幕旋转场景

### Android 设备测试
1. 测试不同厂商的设备（小米、华为、Oppo等）
2. 在室外远离金属物体的环境中测试
3. 检查传感器类型是否正确识别

### 校准验证
1. 使用指南针或GPS应用作为参考
2. 对比多个已知方向的读数
3. 长时间使用检查稳定性

## 未来改进方向

1. **集成 WMM API**：使用专业的世界磁场模型
2. **自动校准**：基于GPS和已知地标自动校准
3. **校准历史**：记录多次校准结果并智能平均
4. **陀螺仪融合**：结合陀螺仪数据提高精度
5. **设备profile**：为已知设备型号维护校准参数库

## 获取帮助

如果遇到问题：
1. 检查浏览器控制台的错误信息
2. 启用调试模式查看详细传感器数据
3. 确认设备支持方向传感器
4. 检查浏览器权限设置

---

**最后更新**: 2025-12-17  
**版本**: 2.0  
**作者**: Antigravity AI Assistant
